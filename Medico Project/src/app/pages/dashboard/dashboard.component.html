<div class="dashboard-container d-flex">

  <!-- ========================= -->
  <!-- Left Panel: Connections -->
  <!-- ========================= -->
  <div class="connections-panel flex-grow-1">

    <!-- Pending Connections -->
    <div class="mt-3">
      <div *ngIf="pendingConnections.length === 0">
        <nb-alert status="warning">No pending requests.</nb-alert>
      </div>

      <div *ngFor="let connection of pendingConnections" class="mt-2">
        <nb-card>
          <nb-card-body>
            <div class="card-content">
              <div class="user-info">
                <img
                  *ngIf="connection.from_user === currentUserId ? connection.to_user_profile_picture_url : connection.from_user_profile_picture_url; else defaultPendingIcon"
                  [src]="connection.from_user === currentUserId ? connection.to_user_profile_picture_url : connection.from_user_profile_picture_url"
                  alt="Profile Picture"
                  class="profile-pic"
                />
                <ng-template #defaultPendingIcon>
                  <i class="nb-person profile-pic"></i>
                </ng-template>

                <div class="details">
                  <div class="username">
                    {{ connection.from_user === currentUserId ? connection.to_user_username : connection.from_user_username }}
                  </div>
                  <div class="role">
                    {{ connection.from_user === currentUserId ? connection.to_user_role : connection.from_user_role }}
                  </div>
                </div>
              </div>

              <div class="pending-actions">
                <button
                  *ngIf="connection.from_user === currentUserId"
                  nbButton
                  status="warning"
                  size="tiny"
                  (click)="cancelConnection(connection.id)"
                >
                  Cancel
                </button>

                <div *ngIf="connection.to_user === currentUserId">
                  <button
                    nbButton
                    status="success"
                    size="tiny"
                    (click)="acceptConnection(connection.id)"
                  >
                    Accept
                  </button>
                  <button
                    nbButton
                    status="danger"
                    size="tiny"
                    (click)="rejectConnection(connection.id)"
                  >
                    Reject
                  </button>
                </div>
              </div>
            </div>
          </nb-card-body>
        </nb-card>
      </div>
    </div>

    <!-- Accepted Connections -->
    <div class="mt-3">
      <div *ngIf="acceptedConnections.length === 0">
        <nb-alert status="info">No connections yet.</nb-alert>
      </div>

      <div *ngFor="let connection of acceptedConnections" class="accepted-connection">
        <div class="user-info">
          <img
            *ngIf="connection.from_user === currentUserId ? connection.to_user_profile_picture_url : connection.from_user_profile_picture_url; else defaultAcceptedIcon"
            [src]="connection.from_user === currentUserId ? connection.to_user_profile_picture_url : connection.from_user_profile_picture_url"
            alt="Profile Picture"
            class="profile-pic"
          />
          <ng-template #defaultAcceptedIcon>
            <i class="nb-person profile-pic"></i>
          </ng-template>

          <div class="details">
            <div class="username">
              {{ connection.from_user === currentUserId ? connection.to_user_username : connection.from_user_username }}
            </div>
            <div class="role">
              {{ connection.from_user === currentUserId ? connection.to_user_role : connection.from_user_role }}
            </div>
          </div>
        </div>

        <button
          nbButton
          status="danger"
          size="tiny"
          (click)="removeConnection(connection.id)"
        >
          Remove
        </button>
    <button
  nbButton
  status="info"
  size="tiny"
  (click)="openVideoCall(
    connection.from_user === currentUserId
      ? connection.to_user
      : connection.from_user
  )"
>
  Video Call
</button>


        <!-- Chat button -->
        <button
          nbButton
          status="primary"
          size="tiny"
          (click)="openChat(connection.from_user === currentUserId 
            ? {
                id: connection.to_user,
                username: connection.to_user_username,
                profile_picture_url: connection.to_user_profile_picture_url,
                role: connection.to_user_role
              }
            : {
                id: connection.from_user,
                username: connection.from_user_username,
                profile_picture_url: connection.from_user_profile_picture_url,
                role: connection.from_user_role
              })"
        >
          Chat
        </button>
                <!-- Book Appointment button -->
 
<button nbButton status="success" size="tiny"
        *ngIf="currentUserRole === 'patient'"
        (click)="bookAppointment(connection.from_user === currentUserId 
                                 ? connection.to_user 
                                 : connection.from_user)">
  Book Appointment
</button>


      </div>
    </div>
  </div>
  

  <!-- ========================= -->
  <!-- Right Panel: Community -->
  <!-- ========================= -->
  <div class="community-panel">
    <nb-card>
      <nb-card-header>Search Community</nb-card-header>
      <nb-card-body>
        <input
          nbInput
          fullWidth
          placeholder="Search community..."
          (input)="onSearch($event.target.value)"
        />
      </nb-card-body>
    </nb-card>

    <div *ngIf="scrollableCommunityUsers.length === 0" class="mt-3">
      <nb-alert status="info">No community users found.</nb-alert>
    </div>

    <div *ngFor="let user of scrollableCommunityUsers" class="mt-2">
      <nb-card>
        <nb-card-body>
          <div class="card-content">
            <div class="user-info">
              <img
                *ngIf="user.profile_picture_url; else defaultAvatar"
                [src]="user.profile_picture_url"
                alt="Profile Picture"
                class="profile-pic"
              />
              <ng-template #defaultAvatar>
                <i class="nb-person profile-pic"></i>
              </ng-template>

              <div class="details">
                <div class="username">{{ user.username }}</div>
                <div class="role">{{ user.role }}</div>
              </div>
            </div>

            <!-- Connect Button -->
            <button
              nbButton
              [status]="getConnectionButtonStatus(user.id)"
              size="tiny"
              [disabled]="isConnectionButtonDisabled(user.id)"
              (click)="connectToUser(user.id)"
            >
              {{ getConnectionButtonLabel(user.id) }}
            </button>

            <p style="font-size: 0.7rem; color: gray;">
              Status: {{ userConnectionStatus[user.id] || 'none' }}
            </p>
          </div>
        </nb-card-body>
      </nb-card>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Floating Chat Windows -->
  <!-- ========================= -->
 <div *ngFor="let chat of openChats; let i = index"
     class="chat-floating-window"
     [style.right.px]="20 + i * 360">
  <ngx-chat [user]="chat.user" [threadId]="chat.threadId" (close)="closeChat(chat)"></ngx-chat>
</div>

<div id="jitsi-container" style="display:none; height:600px; width:100%; margin-top:20px;"></div>

</div>
